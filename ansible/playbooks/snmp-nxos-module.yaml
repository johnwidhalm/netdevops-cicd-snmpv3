---
- name: Configure SNMPv3
  hosts: all
  gather_facts: false
  connection: network_cli
  tasks:
    - name: Configure SNMP User
      nxos_snmp_user:
         user: "{{ item.user }}"
         authentication: "{{ item.auth }}"
         encrypt: "{{ item.encrypt }}"
         privacy: "{{ item.privacy }}"
         pwd: "{{ item.pwd }}"
      with_items: "{{ snmp_users }}"
      notify: config_changed
      register: cli_result

  handlers:
    - name: "HANDLER 1: Display commands to be sent to device"
      listen: config_changed
      debug:
        msg: "{{ cli_result.commands }}"

    - name: "HANDLER 2: Save configuration"
      listen: config_changed
      ios_config:
        save_when: always
